<?php//Força a utilização de HTTPs em todo site/*if (!isset($_SERVER['HTTPS']) || $_SERVER['HTTPS'] !== 'on') {    if(!headers_sent()) {        header("Status: 301 Moved Permanently");        header(sprintf(            'Location: https://%s%s',            $_SERVER['HTTP_HOST'],            $_SERVER['REQUEST_URI']        ));        exit();    }}*/#busca informações do arquivo de configuraçãorequire_once("lib/setup/init.inc.php");#prepara o arquivo css compactadorequire_once("view/css/min.php");session_start();session_cache_expire(30);define("ID_SESSAO", session_id()); // Registra a variavel com ID de sessão//Aceite dos Cookiesif (getRequest('aceite_cookie') != '') {    setSession(1, 'aceite_cookie');}$pagina_requisitada = (isset($_GET['pagina']) && ($_GET['pagina'] != "")) ? $_GET['pagina'] : 'home';$url_rewrite = new UrlRewrite();//Url acessada pelo usuário$url_acesso = "http://" . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];//Verifica se a página está em manutençãoif (MANUTENCAO == "true" && $pagina_requisitada != "manutencao" && !strpos($url_acesso, "gestao")) {    $ips_liberados = explode(',', MANUTENCAO_IP);    if (!in_array($_SERVER["REMOTE_ADDR"], $ips_liberados)) {        header("Location: " . BASE_SITE_URL . "/manutencao");        exit();    }}// Remontam todos parametros passados na URL$url_params = explode("?", str_replace("&amp;", "&", $_SERVER['REQUEST_URI']));if (count($url_params) > 1) {    $params = explode("&", $url_params[1]);    for ($i = 0; $i < count($params); $i++) {        $param = explode("=", $params[$i]);        if (isset($param[0]) && isset($param[1])) $_GET[$param[0]] = $param[1];    }}//permissoes de pagina$liberado_visualizar = true;$liberado_incluir = true;$liberado_alterar = true;$liberado_excluir = true;$array_requisicao = explode("/", $pagina_requisitada);if (count($array_requisicao) > 1) {    $pasta = $array_requisicao[0];    if ($pasta == "gestao") {        $url_rewrite->setTipoUrl("A");        // testando se o usuario admin está logado        if ($array_requisicao[1] != "login.html" && getSession("id_usuario", "info_user") == "") {            $_SESSION['redirecionar'] = $_SERVER["REQUEST_URI"];            header("Location: login.html");            die;        }        if ($array_requisicao[1] == "")            $pagina_requisitada = "gestao/index.phtml";        else {            $url_rewrite->setUrlDestino($array_requisicao[1]);            $pagina_requisitada = ($url_rewrite->getOrigem()) ? $url_rewrite->getUrlOrigem() : "404.html";            if ($pagina_requisitada != "404.html") {                $objPagina = new Pagina();                $pagina_name = str_replace('.html', '', str_replace('ajax-', '', str_replace('-lista.html', '', str_replace('-form.html', '', $url_rewrite->getUrlDestino()))));                if ($pagina_name != "login" && $pagina_name != "home") {                    $pagina = $objPagina->getByName($pagina_name);                    $liberado_visualizar = Perfil::verificaPermissao(getSession("id_perfil", "info_user"), $pagina->id_pagina, 'visualizar');                    $liberado_incluir = Perfil::verificaPermissao(getSession("id_perfil", "info_user"), $pagina->id_pagina, 'incluir');                    $liberado_alterar = Perfil::verificaPermissao(getSession("id_perfil", "info_user"), $pagina->id_pagina, 'alterar');                    $liberado_excluir = Perfil::verificaPermissao(getSession("id_perfil", "info_user"), $pagina->id_pagina, 'excluir');                }                //exit(var_dump(strpos($pagina_requisitada,$pagina_name.'/form.phtml')));                /*if(!$liberado_incluir && strpos($pagina_requisitada,$pagina_name.'/form.phtml') !== false && !getRequest('id')){                    header("Location: home.html?permissao=1");                    die;                }*/                if (!$liberado_visualizar && (strpos($pagina_requisitada, $pagina_name . '/form.phtml') !== false || strpos($pagina_requisitada, $pagina_name . '/lista.phtml') !== false)) {                    header("Location: home.html?permissao=1");                    die;                }                /*if(!$liberado_alterar && getRequest('acao') !== 'alterar'){                    header("Location: home.html?permissao=1");                    die;                }*/            }        }    } // url amigaveis com ID's aqui    else {        $url_rewrite->setTipoUrl("S");        $url_rewrite->setUrlDestino($pagina_requisitada);        if ($url_rewrite->getOrigem()) {            $pagina_requisitada = $url_rewrite->getUrlOrigem();        } else {            switch ($pasta) {                case "servico":                    $url_rewrite = end($array_requisicao);                    $servico = new Servico();                    $id_servico = $servico->getIdByUrlRewrite($url_rewrite);                    if ($id_servico) {                        $servico->setIdTable($id_servico);                        $servico->getByCod();                        if ($servico->getStatus() != 'A') {                            header('Location: ' . BASE_SITE_URL);                            die;                        } else {                            $_GET['id_servico'] = $id_servico;                            $pagina_requisitada = 'view/servico.phtml';                        }                    }                    break;                case "artigo":                    $url_rewrite = end($array_requisicao);                    $artigo = new Artigo();                    $id_artigo = $artigo->getIdByUrlRewrite($url_rewrite);                    if ($id_artigo) {                        $artigo->setIdTable($id_artigo);                        $artigo->getByCod();                        if ($artigo->getStatus() != 'A') {                            header('Location: ' . BASE_SITE_URL);                            die;                        } else {                            $_GET['id_artigo'] = $id_artigo;                            $pagina_requisitada = 'view/artigo.phtml';                        }                    }                    break;            }        }    }} else {    $url_rewrite->setTipoUrl("S");    // casos de migracao de php para html    if (substr_count($pagina_requisitada, '.php') > 0) {        $url_rewrite->setUrlOrigem($pagina_requisitada);        $pagina_requisitada = ($url_rewrite->getDestino()) ? $url_rewrite->getUrlDestino() : "404.html";        header("HTTP/1.1 301 Moved Permanently");        header("Location: " . BASE_SITE_URL . "/" . $pagina_requisitada);    } else {        $url_rewrite->setUrlDestino($pagina_requisitada);        $pagina_requisitada = ($url_rewrite->getOrigem()) ? $url_rewrite->getUrlOrigem() : "404.html";    }}$pagina_requisitada = (file_exists($pagina_requisitada)) ? $pagina_requisitada : "404.html";$pagina_requisitada = ($pagina_requisitada == "404.html") ? "view/error/404.phtml" : $pagina_requisitada;include_once($pagina_requisitada);